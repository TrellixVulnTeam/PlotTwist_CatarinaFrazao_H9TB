{% extends 'base-template.html' %}

{% block title %} Consulta de Clientes {% endblock %}

{% if loggedin %}

{% block breadcrumb %}

{% if breadcrumb %}
<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
    <div class="row">
        <ol class="breadcrumb">
            <li><a href="#">
                    <em class="fa fa-home"></em>
                </a></li>
            <li class="active">{{breadcrumb}}</li>
        </ol>
    </div>
    <!--/.row-->
    {% endif %}
    <!--/endif breadcrumb-->
    {% endblock %}

    {% block page_header %}

    {% if page_header %}
    <div class="row">
        <div class="col-lg-12">
            <h3 class="page-header">{{page_header}}</h3>
        </div>
    </div>
    <!--/.row-->
    {% endif %}
    <!--/endif page_header-->
    {% endblock %}

    {% block content %}
    <!--/consulta-->

    <div class="row">
        <div class="col-md-4">
            <button type="button" class="btn btn-success" id="Adicionar" data-toggle="modal"
                data-target="#ModalAdicionaCliente">
                Adicionar
            </button>
        </div>
    </div>

    <div class="col">
        <br>
        <table id="ListaCliente" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>CPF</th>
                    <th>Nome</th>
                    <th>Celular</th>
                    <th>Email</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente[0] }}</td>
                    <td>{{ cliente[1] }}</td>
                    <td>{{ cliente[2] }}</td>
                    <td>{{ cliente[3] }}</td>
                    <td>{{ cliente[4] }}</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                data-target="#ModalAlteraCliente{{ cliente[0] }}">
                                Alterar
                            </button>

                            <button type="button" class="btn btn-danger deletar" id="Delete" value="{{ cliente[0] }}">
                                Deletar
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!--/Modal do Botão para Alterar-->
{% for cliente in clientes %}
<div class="modal fade" id="ModalAlteraCliente{{ cliente[0] }}">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Alteração de Cliente</h4>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>
            </div>
            <div class="modal-body mx-3">
                <form name="formAlterar"  role="form" method="POST" action="{{ url_for('alterar_cliente') }}">
                    <div class="md-form mb-5">
                        <label for="idCliente">Id</label>
                        <input value="{{ cliente[0] }}" class="form-control validate" name="idCliente" id="idCliente" maxlength="55" 
                            readonly>
                    </div>
                    <div class="md-form mb-5">
                        <label for="CPF" class="control-label">CPF</label>
                        <input value="{{ cliente[1] }}" type="text" class="form-control altcpf" name="CPF" id="idAltCPF" readonly>
                    </div>
                    <div class="md-form mb-5" id="divAltNome">
                        <label for="NomeCliente" class="control-label">**Nome</label>
                        <input value="{{ cliente[2] }}" type="text" class="form-control text-lowercase" name="NomeCliente"
                            id="idAltNome" placeholder="nome do cliente" maxlength="30" required>
                            <p id="msgaltnome"></p>
                    </div>

                    <div class="md-form mb-5" id="divAltCelular">
                        <label for="Celular" class="control-label" >**Celular</label>
                        <input value="{{ cliente[3] }}" type="tel" class="form-control altcelular" name="Celular" id="idAltCelular"
                        placeholder="(00) 0 0000-0000" required>
                        <p id="msgaltcelular"></p>

                    </div>
                    <div class="md-form mb-5" id="divAltEmail">
                        <label for="Email" class="control-label">Email</label>
                        <input value="{{ cliente[4] }}" type="text" class="form-control text-lowercase" name="Email" id="idAltEmail"
                        placeholder="user@dominio.com" maxlength="40">
                        <p id="msgaltemail"></p>
                    </div>
                    <br>
                    <p class="text-info"><b>**Campos Obrigatórios</b></p>
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!--/Modal do Botão para Criar-->
<div class="modal fade" id="ModalAdicionaCliente">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cadastrar Cliente</h4>
            </div>
            <div class="modal-body mx-3">
                <form name="formCriar" autocomplete="off" id="formCriar" role="form" method="POST" action="{{ url_for('criar_cliente') }}">
                    <div class="form-group " id="divNome">
                        <label for="NomeCliente" class="control-label">**Nome</label>
                        <input type="text" class="form-control text-lowercase" name="NomeCliente" id="idNome"
                            placeholder="nome do cliente" maxlength="30" required>
                            <p id="msgnome"></p>
                    </div>
                    <div class="form-group " id="divCPF">
                        <label for="CPF" class="control-label">**CPF</label>
                        <input type="numeric" class="form-control cpf" name="CPF" id="idCPF" placeholder="000.000.000.00"
                            required>
                        <p id="msgcpf"></p>
                        </div>
                    <div class="form-group " id="divCelular">
                        <label for="Celular" class="control-label">**Celular</label>
                        <input type="tel" class="form-control celular" name="Celular" id="idCelular"
                            placeholder="(00) 0 0000-0000" required>
                            <p id="msgcelular"></p>

                    </div>
                    <div class="form-group" id="divEmail">
                        <label for="Email" class="control-label">E-mail</label>
                        <input type="email" class="form-control text-lowercase" name="Email" id="idEmail" placeholder="user@dominio.com"
                        maxlength="40">
                        <p id="msgemail"></p>
                    </div>
                    <p class="text-info"><b>**Campos Obrigatórios</b></p>
                    <br>
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>


{% endfor %}

<script>
$('#ModalAdicionaCliente').on('hidden.bs.modal', function (event) {
  console.log('Destroy modal');

});

    $(document).ready(function () {

//Cria uma datatables
        $('#ListaCliente').DataTable();

//Envia informações para o python deletar dados
        $('.deletar').click(function () {
            var idCliente = $(this).val()
            Swal.fire({
                icon: 'warning',
                title: 'Tem certeza?',
                text: 'Este processo não pode ser desfeito!',
                showCancelButton: true,
                confirmButtonText: 'Excluir!',
                cancelButtonText: 'Cancelar!'
            }).then((result) => {
                if (result.value) {
                    $.post('deletar_cliente', { id: idCliente }, function(msg){
                    Swal.fire({
                        title: msg,
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    })}
                    );

                }
            })
        })
//Mascaras
        $('.celular').mask('(99) 9 9999-9999');

        $(".cpf").mask('999.999.999-99', { reverse: true });

        $('.altcelular').mask('(99) 9 9999-9999');

        $(".altcpf").mask('999.999.999-99', { reverse: true });

//Variaveis FORM 
        var statusNome = null;
        var statusCPF = null;
        var statusCelular = null;
        var statusEmail = null;

        var idCPF = document.getElementById("idCPF")
        var divCPF = document.getElementById("divCPF")

        var idEmail = document.getElementById("idEmail")
        var divEmail = document.getElementById("divEmail")
  

        var idCelular = document.getElementById("idCelular")
        var divCelular = document.getElementById("divCelular")

        var idNome = document.getElementById("idNome")
        var divNome = document.getElementById("divNome")

        var idAltEmail = document.getElementById("idAltEmail")
        var divAltEmail = document.getElementById("divAltEmail")
  

        var idAltCelular = document.getElementById("idAltCelular")
        var divAltCelular = document.getElementById("divAltCelular")

        var idAltNome = document.getElementById("idAltNome")
        var divAltNome = document.getElementById("divAltNome")


        function acaoInput(func, div) {
            if (func == 'none') {
                div.classList.remove("has-success");
                div.classList.remove("has-error");
                return func;
            }

            if (func == true) {
                div.classList.add("has-success");
                div.classList.remove("has-error");
                return func;
            }

            if (func == false){
                div.classList.add("has-error");
                div.classList.remove("has-success");
                return func;
            }
        }

//Validar Formulário para Envio
var form = document.getElementById('formCriar');

form.addEventListener('submit', function(e) {
            if ((statusNome == true) &&
            (statusCPF == true) &&
            (statusCelular == true) &&
            (statusEmail == true || statusEmail == 'none'))
            {
                Swal.fire({
                        title: 'Cadastro realizado!',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    })
            }
            else {e.preventDefault();}

        })
       

//Validar Email
        idEmail.addEventListener("blur", function () {
            var ret = acaoInput(validarEmail(idEmail), divEmail);
            if (ret){
                document.getElementById("msgemail").innerHTML = "<font color ='green'> E-mail válido! </font>" ;

            }
            if (ret == false){
                document.getElementById("msgemail").innerHTML = "<font color ='red'> E-mail inválido! </font>";

            }
            if (ret == 'none'){
                document.getElementById("msgemail").innerHTML = "";
            }
        });
        idAltEmail.addEventListener("blur", function () {
            var ret = acaoInput(validarEmail(idAltEmail), divAltEmail);
            console.log('opa')
            if (ret == true){
                console.log('bom')

                document.getElementById("msgaltemail").innerHTML = "<font color ='green'> E-mail válido! </font>" ;
            }
            if (ret == false){
                document.getElementById("msgaltemail").innerHTML = "<font color ='red'> E-mail inválido! </font>";
            }
            if (ret == 'none'){
                document.getElementById("msgaltemail").innerHTML = "";

            }
        });
        function validarEmail(field) {
            var usuario = field.value.substring(0, field.value.indexOf("@"));
            var dominio = field.value.substring(field.value.indexOf("@") + 1, field.value.length);
            if ((usuario.length == 0) &&
                (dominio.length == 0))
                {
                return statusEmail = 'none';
                }

            if ((usuario.search("@") == -1) &&
                (dominio.search("@") == -1) &&
                (usuario.search(" ") == -1) &&
                (dominio.search(" ") == -1) &&
                (dominio.search(".") != -1) &&
                (dominio.indexOf(".") >= 1) &&
                (dominio.lastIndexOf(".") < dominio.length - 1)) {

                return statusEmail = true;
            }

            else {

                return statusEmail = false;
            }
        }
//Validar CPF
        idCPF.addEventListener("blur", function () {
            var ret = acaoInput(validarCPF(), divCPF);
            if (ret == true){
                document.getElementById("msgcpf").innerHTML = "<font color ='green'> CPF válido! </font>";

            }
            if (ret == false){
                document.getElementById("msgcpf").innerHTML = "<font color ='red'> CPF inválido! </font>";

            }
            else{

            }
        });

        function validarCPF() {
            var cpf = $('.cpf').cleanVal();

            // Elimina CPFs invalidos conhecidos	
            if (cpf.length != 11 ||
                cpf == "00000000000" ||
                cpf == "11111111111" ||
                cpf == "22222222222" ||
                cpf == "33333333333" ||
                cpf == "44444444444" ||
                cpf == "55555555555" ||
                cpf == "66666666666" ||
                cpf == "77777777777" ||
                cpf == "88888888888" ||
                cpf == "99999999999"){
                return statusCPF = false;}
            // Valida 1o digito	
            add = 0;
            for (i = 0; i < 9; i++)
                add += parseInt(cpf.charAt(i)) * (10 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(9))){
                return statusCPF = false;}
            // Valida 2o digito	
            add = 0;
            for (i = 0; i < 10; i++)
                add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(10))){
                return statusCPF = false;}
            return statusCPF = true;
        }

//Validar Celular
        idCelular.addEventListener("blur", function () {
            var ret = acaoInput(validPhone(idCelular), divCelular);
            if (ret == true){
                document.getElementById("msgcelular").innerHTML = "<font color ='green'> Celular válido! </font>" ;

            }
            if (ret == false){
                document.getElementById("msgcelular").innerHTML = "<font color ='red'> Celular inválido! </font>" ;

            }
            else{

            }
        });
        idAltCelular.addEventListener("blur", function () {
            var ret = acaoInput(validPhone(idAltCelular), divAltCelular);
            if (ret == true){
                document.getElementById("msgaltcelular").innerHTML = "<font color ='green'> Celular válido! </font>" ;

            }
            if (ret == false){
                document.getElementById("msgaltcelular").innerHTML = "<font color ='red'> Celular inválido! </font>" ;

            }
            else{
                
            }
        });
        function validPhone(phone){
            var celular = phone.value.toString();
            var reg = new RegExp(/(\(\d{2}\)\s)([9]\s)(\d{4}\-\d{4})$/);
            var res = reg.test(celular);
            
            if (res) {
                return statusCelular = res
            }
            else {
                return statusCelular = res
            }
        }
//Validar Nome
        idNome.addEventListener("blur", function () {
            var ret = acaoInput(validaNome(idNome), divNome);
            if (ret == true){
                document.getElementById("msgnome").innerHTML = "<font color ='green'> Nome válido! </font>" ;

            }
            if (ret == false){
                document.getElementById("msgnome").innerHTML = "<font color ='red'> Nome inválido! </font>" ;

            }
            else{
                
            }
        });
        idAltNome.addEventListener("blur", function () {
            var ret = acaoInput(validaNome(idAltNome), divAltNome);
            if (ret == true){
                document.getElementById("msgaltnome").innerHTML = "<font color ='green'> Nome válido! </font>" ;
            }
            if (ret == false){
            document.getElementById("msgaltnome").innerHTML = "<font color ='red'> Nome inválido! </font>" ;
            }
            else{
                
            }
        });
        function validaNome(nome){

            var nomes = nome.value.trim().split(' ');
            if(nomes.length > 1){
            var valido = false;
            for(var x=0;x<nomes.length;x++){
                if(nomes[x].match(/^[a-zA-Z\u00C0-\u017F´]*$/)){
                    valido = true;
                }else{
                    valido = false;
                    break;
                }
            }
            
            if(valido){

                return statusNome = valido;
            }
            }

            return statusNome = false;
            }
    })
</script>

{% endblock %}

{% endif %}